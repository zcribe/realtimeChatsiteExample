<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chatroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128+Text&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding-bottom: 3rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
      }

      .libre-barcode-128-text-regular {
        font-family: "Libre Barcode 128 Text", system-ui;
        font-weight: 400;
        font-style: normal;
      }

      .body-bg {
        background: hsla(265, 53%, 29%, 1);

        background: linear-gradient(
          90deg,
          hsla(265, 53%, 29%, 1) 0%,
          hsla(24, 93%, 73%, 1) 100%
        );

        background: -moz-linear-gradient(
          90deg,
          hsla(265, 53%, 29%, 1) 0%,
          hsla(24, 93%, 73%, 1) 100%
        );

        background: -webkit-linear-gradient(
          90deg,
          hsla(265, 53%, 29%, 1) 0%,
          hsla(24, 93%, 73%, 1) 100%
        );

        filter: progid: DXImageTransform.Microsoft.gradient(startColorstr="#432371", endColorstr="#FAAE7B", GradientType=1);
      }
    </style>
  </head>

  <body
    class="body-bg min-h-screen pt-12 md:pt-20 pb-6 px-2 md:px-0"
    style="font-family: 'Lato', sans-serif"
  >
    <header class="max-w-lg mx-auto">
      <a href="#">
        <h1
          class="text-7xl font-bold text-white text-center libre-barcode-128-text-regular"
        >
          CHATTYMAN
        </h1>
      </a>
    </header>

    <main
      id="login-panel"
      class="bg-white max-w-lg mx-auto p-8 md:p-12 my-10 rounded-lg shadow-2xl"
    >
      <section>
        <h3 class="font-bold text-2xl">Welcome to Chattyman</h3>
        <p class="text-gray-600 pt-2">Sign in to your account.</p>
      </section>

      <section class="mt-10">
        <form class="flex flex-col" id="login-form">
          <div class="mb-6 pt-3 rounded bg-gray-200">
            <label
              class="block text-gray-700 text-sm font-bold mb-2 ml-3"
              for="username"
              >Username</label
            >
            <input
              type="text"
              id="username"
              name="username"
              value="john"
              class="bg-gray-200 rounded w-full text-gray-700 focus:outline-none border-b-4 border-gray-300 focus:border-purple-600 transition duration-500 px-3 pb-3"
            />
          </div>
          <div class="mb-6 pt-3 rounded bg-gray-200">
            <label
              class="block text-gray-700 text-sm font-bold mb-2 ml-3"
              for="password"
              >Password</label
            >
            <input
              type="password"
              id="password"
              name="password"
              value="changeit"
              class="bg-gray-200 rounded w-full text-gray-700 focus:outline-none border-b-4 border-gray-300 focus:border-purple-600 transition duration-500 px-3 pb-3"
            />
          </div>
          <button
            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded shadow-lg hover:shadow-xl transition duration-200"
            type="submit"
          >
            Sign In
          </button>
        </form>
      </section>
    </main>

    <main
      id="home-panel"
      class="container mx-auto grid grid-flow-row-dense grid-cols-3"
    >
      <section class="mt-10 grid grid-cols-4 gap-10">
        <div class="bg-white p-8 md:p-7 my-10 rounded-lg shadow-2x relative">
          <p
            class="block text-gray-700 text-sm font-bold mb-2 ml-3 flex-none left-5 absolute"
          >
            Members:
          </p>
          <ul id="members" class="overflow-y-auto mt-7 bg-gray-100 rounded px-5 min-h-96 max-h-96 "></ul>
          <form id="logout-form" class="absolute bottom-5 left-5">
            <button
              class="px-3 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 rounded shadow-lg hover:shadow-xl transition duration-200"
              type="submit"
              value="Log out"
            >
              Log out
            </button>
          </form>
        </div>
        <div
          class="bg-white p-8 md:p-12 my-10 rounded-lg shadow-2xl col-span-3 flex flex-col"
        >
          <h2 class="block text-gray-700 font-bold mb-2 ml-3 flex-none">
            Chatroom
          </h2>
          <ul
            id="messages"
            class="bg-slate-100 my-3 min-h-96 max-h-96 p-5 overflow-y-auto rounded relative"
          >
            <p
              id="typing"
              class="absolute bottom-2 left-2 text-gray-400 text-sm"
            >
              is typing...
            </p>
          </ul>
          <div class="p-1 flex-none">
            <form id="form" action="" class="flex">
              <input
                id="input"
                autocomplete="off"
                class="bg-gray-200 rounded w-full text-gray-700 focus:outline-none border-b-4 border-gray-300 focus:border-purple-600 transition duration-500 p-3"
              />
              <button
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded shadow-lg hover:shadow-xl transition duration-200 px-3 ml-1"
              >
                Send
              </button>
            </form>
          </div>
        </div>
      </section>
    </main>

    <div class="max-w-lg mx-auto text-center mt-12 mb-6">
      <p class="text-white">
        Don't have an account?
        <a href="#" class="font-bold hover:underline">Sign up</a>.
      </p>
    </div>

    <div style="display: none">
      <p>Not authenticated</p>
      <form id="login-form">
        <div>
          <label for="username">Username:</label>
          <input type="text" id="username" name="username" value="john" />
          <br />
        </div>
        <div>
          <label for="password">Password:</label>
          <input
            type="password"
            id="password"
            name="password"
            value="changeit"
          />
        </div>
        <div>
          <input type="submit" value="Submit" />
        </div>
      </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const loginPanel = document.getElementById("login-panel");
      const homePanel = document.getElementById("home-panel");
      const loginForm = document.getElementById("login-form");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const socketIdSpan = document.getElementById("socket-id");
      const logoutForm = document.getElementById("logout-form");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");
      const typing = document.getElementById("typing");
      const members = document.getElementById("members");

      let socket;

      async function main() {
        const token = localStorage.getItem("token");

        if (!token) {
          return showLoginPanel();
        }

        const res = await fetch("/self", {
          headers: {
            authorization: `bearer ${token}`,
          },
        });

        if (res.status === 200) {
          showHomePanel();
        } else {
          showLoginPanel();
        }
      }

      function showHomePanel() {
        loginPanel.style.display = "none";
        homePanel.style.display = "block";

        // this will only work if HTTP long-polling is enabled, since WebSockets do not support providing additional headers
        socket = io({
          extraHeaders: {
            authorization: `bearer ${localStorage.getItem("token")}`,
          },
        });

        socket.on("connect", () => {
          socket.emit("whoami", (username) => {
          });
        });

        socket.on("disconnect", () => {
        });

        socket.on("chat message", (msg) => {
          const item = document.createElement("li");
          item.textContent = msg;
          messages.appendChild(item);
          window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on("user left", (msg) => {
          const item = document.createElement("li");
          item.textContent = msg;
          messages.appendChild(item);
          window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on("members", (list) => {
            console.log(list)
          list.forEach((element) => {
            const item = document.createElement("li");
            item.textContent = element;
            members.appendChild(item);
          });

          window.scrollTo(0, document.body.scrollHeight);
        });
      }

      function showLoginPanel() {
        loginPanel.style.display = "block";
        homePanel.style.display = "none";
      }

      loginForm.onsubmit = async function (e) {
        e.preventDefault();

        const res = await fetch("/login", {
          method: "post",
          headers: {
            "content-type": "application/json",
          },
          body: JSON.stringify({
            username: usernameInput.value,
            password: passwordInput.value,
          }),
        });

        if (res.status === 200) {
          const { token } = await res.json();
          localStorage.setItem("token", token);
          // window.location.href='/chatroom'
          showHomePanel();
        } else {
          passwordInput.value = "";
        }
      };

      logoutForm.onsubmit = function (e) {
        e.preventDefault();

        socket.disconnect();
        localStorage.removeItem("token");

        showLoginPanel();
      };

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit("chat message", input.value);
          input.value = "";
        }
      });

      main();
    </script>
  </body>
</html>
